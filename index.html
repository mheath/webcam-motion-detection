<!DOCTYPE html>
<html>
<head>
    <title></title>


</head>
<body>
    <div>Test</div>
    <video id="video" autoplay></video>
    <canvas id="snapshot" width="640" height="480" style="visibility: none"></canvas>
    <canvas id="diff" width="640" height="480"></canvas>

    <script type="text/javascript">
        var video = document.querySelector('#video');
        var canvas = document.querySelector('#snapshot');
        var ctx = canvas.getContext('2d');
        var canvas2 = document.querySelector('#diff');
        var ctx2 = canvas2.getContext('2d');
        var localMediaStream = null;
        var imageData = null;

        function snapshot() {
            ctx.drawImage(video, 0, 0);
            var current = ctx.getImageData(0, 0, canvas.width, canvas.height);

            if (imageData != null) {
                var newImage = ctx2.createImageData(canvas2.width, canvas2.height);
                for (var i = 0; i < imageData.data.length; i+=4) {
                    var rDelta = Math.abs(imageData.data[i] - current.data[i]);
                    var gDelta = Math.abs(imageData.data[i + 1] - current.data[i + 1]);
                    var bDelta = Math.abs(imageData.data[i + 2] - current.data[i + 2]);
                    var delta = (rDelta + gDelta + bDelta) / 3;
                    if (delta > 50) {
                        newImage.data[i] = 100;
                        newImage.data[i + 1] = 100;
                        newImage.data[i + 2] = 100;
                    }
                    newImage.data[i + 3] = 255;
                }
                ctx2.putImageData(newImage, 0, 0);
            }

            imageData = current;
            setTimeout(snapshot, 300);
        }

        navigator.webkitGetUserMedia({'video':true}, function(stream) {
            console.log(stream);
            var url = window.webkitURL.createObjectURL(stream);
            console.log(url)
            video.src = url;
            localMediaStream = stream;
            snapshot();
        }, function(e) {
            console.log("Failed!",e);
        });

    </script>

</body>
</html>
